name: "Update sources"

on:
    workflow_dispatch:
    schedule:
        - cron: "0 6 * * 1"

jobs:
    update-sources:
        runs-on: ubuntu-latest

        defaults:
            run: { shell: bash }

        steps:

        - name: Checkout
          uses: actions/checkout@v4

        - name: Setup nix
          uses: MidAutumnMoon/spheti-action/nix@master
          with:
            cachix-url: "https://nuirrce.cachix.org/"
            cachix-pubkey: "nuirrce.cachix.org-1:KQWa6ZfDkMPXeDiUpmyDhNw4CmgybPyeVklmi/1Rtqk="

        - name: Run nvfetcher
          id: nvfetcher_results
          run: |
            pushd "packages"
            declare -r TEMP="$(mktemp)"

            nix run --print-build-logs \
                .#nuranScripts.nvfetcher-driver -- "sources.toml" "__sources" "${{ github.token }}" \
            | tee "$TEMP"

            # just pivot away you f* bash
            {
                echo "content<<WHEREDOC"
                # only needs the changes in the PR
                sed '0,/^Changes/d' "$TEMP"
                echo "WHEREDOC"
            } >> "$GITHUB_OUTPUT"

        - name: Open PR
          uses: peter-evans/create-pull-request@v6
          with:
            add-paths: "packages"
            delete-branch: true
            title: "sources: update [bot]"
            commit-message: "sources: update [bot]"
            committer: "GitHub <noreply@github.com>"
            author: "GitHub <noreply@github.com>"
            body: ${{ steps.nvfetcher_results.outputs.content }}

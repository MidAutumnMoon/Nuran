name: "Build custom Caddy"

on:
    workflow_dispatch:
    schedule:
        - cron: "0 0 */7 * *"

jobs:

    update-sources:

        runs-on: ubuntu-latest

        defaults:
            run: { shell: bash }

        env:
            HASH_METHOD: xxh64sum
            OUTPUT_CADDY: caddy

        steps:

        - name: Checkout repo
          uses: actions/checkout@v4

        - name: Setup nix
          uses: MidAutumnMoon/spheti-action/nix@master

        - name: Install tools
          run: |
            nix profile install nixpkgs#{fish,xxHash,jq,xcaddy}
            # Create shims for xxhash
            sudo ln -s "$(which xxhsum)" "/usr/local/bin/$HASH_METHOD"

        - name: Build with xcaddy
          run: |
            fish packages/__scripts/xcaddy-build.fish

        - name: Try
          run: |
            $HASH_METHOD $OUTPUT_CADDY
